<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯å¤«æ ¼æ ¼ç®¡ç†ç³»çµ±</title>
    <!-- æ ¸å¿ƒåº«è¼‰å…¥ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #FDF8F5; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .receipt-card { background-color: #FDF8F5; padding: 1.5rem; border-radius: 2.5rem; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, memo, useCallback } = React;

        // --- å®‰å…¨åœ–ç¤ºçµ„ä»¶ (SVG) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                plus: <path d="M12 5v14M5 12h14" />,
                minus: <path d="M5 12h14" />,
                user: <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                trash: <g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></g>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                cart: <g><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></g>,
                chef: <g><path d="M6 18h12"/><path d="M12 10V4.5a2.5 2.5 0 0 0-5 0V10a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2V8"/><path d="M12 10V4.5a2.5 2.5 0 0 1 5 0V10a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V8"/><path d="M18 18a4 4 0 1 1-8 0"/></g>,
                back: <g><polyline points="15 18 9 12 15 6"/></g>,
                close: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                chart: <g><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></g>,
                pin: <g><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></g>,
                truck: <g><rect width="16" height="10" x="2" y="6" rx="2"/><path d="M18 8h3l3 3v5h-6"/><circle cx="6.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></g>,
                card: <g><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></g>,
                clipboard: <g><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></g>,
                check: <polyline points="20 6 9 17 4 12"/>,
                undo: <g><path d="M3 7V5c0-1.1.9-2 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><polyline points="9 11 12 14 15 11"/></g>,
                send: <g><line x1="22" y1="2" x2="11" y2="13"/><polyline points="22 2 15 22 11 13 2 9 22 2"/></g>,
                target: <g><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></g>,
                gift: <g><rect width="18" height="14" x="3" y="8" rx="2"/><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0 5.997 0A4 4 0 0 0 17.997 5.125 3 3 0 1 0 12 5Z"/><line x1="12" x2="12" y1="22" y2="8"/></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const flavorNames = { original: 'åŸå‘³', strawberry: 'è‰è“', cocoa: 'å¯å¯', matcha: 'æŠ¹èŒ¶' };
        const extraNames = { cream: 'é®®å¥¶æ²¹', bag: 'æè¢‹è²»($2)', receipt: 'æ”¶æ“š', sugar: 'ç³–ç²‰', fork: 'å‰å­' };
        const bankInfo = { bankName: "ä¸­åœ‹ä¿¡è¨— (822)", accountName: "å½­æ°¸ç¿”", accountNumber: "1755 4046 3472" };

        const productCategories = {
            '8å…¥': [
                { id: '8_orig', label: '8å…¥ åŸå‘³', price: 75, balls: 8, flavors: ['original'] },
                { id: '8_straw', label: '8å…¥ è‰è“', price: 95, balls: 8, flavors: ['strawberry'] },
                { id: '8_matcha', label: '8å…¥ æŠ¹èŒ¶', price: 80, balls: 8, flavors: ['matcha'] },
                { id: '8_cocoa', label: '8å…¥ å¯å¯', price: 75, balls: 8, flavors: ['cocoa'] },
            ],
            '4å…¥': [
                { id: '4_orig', label: '4å…¥ åŸå‘³', price: 45, balls: 4, flavors: ['original'] },
                { id: '4_straw', label: '4å…¥ è‰è“', price: 60, balls: 4, flavors: ['strawberry'] },
                { id: '4_matcha', label: '4å…¥ æŠ¹èŒ¶', price: 55, balls: 4, flavors: ['matcha'] },
                { id: '4_cocoa', label: '4å…¥ å¯å¯', price: 50, balls: 4, flavors: ['cocoa'] },
            ],
            '4å…¥é›™è‰²': [
                { id: '4_os', label: 'åŸå‘³+è‰è“', price: 60, balls: 4, flavors: ['original', 'strawberry'] },
                { id: '4_om', label: 'åŸå‘³+æŠ¹èŒ¶', price: 55, balls: 4, flavors: ['original', 'matcha'] },
                { id: '4_oc', label: 'åŸå‘³+å¯å¯', price: 50, balls: 4, flavors: ['original', 'cocoa'] },
                { id: '4_sm', label: 'è‰è“+æŠ¹èŒ¶', price: 65, balls: 4, flavors: ['strawberry', 'matcha'] },
                { id: '4_sc', label: 'è‰è“+å¯å¯', price: 60, balls: 4, flavors: ['strawberry', 'cocoa'] },
                { id: '4_cm', label: 'æŠ¹èŒ¶+å¯å¯', price: 60, balls: 4, flavors: ['matcha', 'cocoa'] },
            ],
            'ç¶œåˆ': [
                { id: '8_mix', label: '8å…¥ å››è‰²ç¶œåˆ', price: 110, balls: 8, flavors: ['original', 'strawberry', 'cocoa', 'matcha'] },
                { id: '4_mix', label: '4å…¥ å››è‰²ç¶œåˆ', price: 65, balls: 4, flavors: ['original', 'strawberry', 'cocoa', 'matcha'] },
            ],
            'çœŸç©ºåŒ…': [
                { id: 'v_40_o', label: 'çœŸç©º40 åŸå‘³', price: 320, balls: 40, flavors: ['original'], vType: 40 },
                { id: 'v_40_s', label: 'çœŸç©º40 è‰è“', price: 500, balls: 40, flavors: ['strawberry'], vType: 40 },
                { id: 'v_40_c', label: 'çœŸç©º40 å¯å¯', price: 385, balls: 40, flavors: ['cocoa'], vType: 40 },
                { id: 'v_40_m', label: 'çœŸç©º40 æŠ¹èŒ¶', price: 380, balls: 40, flavors: ['matcha'], vType: 40 },
                { id: 'v_80_o', label: 'çœŸç©º80 åŸå‘³', price: 550, balls: 80, flavors: ['original'], vType: 80 },
                { id: 'v_80_s', label: 'çœŸç©º80 è‰è“', price: 790, balls: 80, flavors: ['strawberry'], vType: 80 },
                { id: 'v_80_c', label: 'çœŸç©º80 å¯å¯', price: 700, balls: 80, flavors: ['cocoa'], vType: 80 },
                { id: 'v_80_m', label: 'çœŸç©º80 æŠ¹èŒ¶', price: 750, balls: 80, flavors: ['matcha'], vType: 80 },
            ]
        };

        const calculatePacking = (items) => {
            let large = 0, small = 0, v40 = 0, v80 = 0;
            (items || []).forEach(i => {
                const id = i.id || '';
                if (id.includes('8_') || id === '8_mix') large += (i.qty || 0);
                else if (id.includes('4_') || id === '4_mix') small += (i.qty || 0);
                if (i.vType === 40) v40 += (i.qty || 0);
                if (i.vType === 80) v80 += (i.qty || 0);
            });
            let bag6 = 0, bag4 = 0;
            let tL = large, tS = small;
            while (tL >= 9 || tS >= 12) { bag6++; tL = Math.max(0, tL - 9); tS = Math.max(0, tS - 12); }
            while (tL > 0 || tS > 0) { bag4++; tL = Math.max(0, tL - 5); tS = Math.max(0, tS - 6); }
            return { bag6, bag4, cooler: Math.ceil(v40 / 2) + v80 };
        };

        const getDoughDemand = (items) => {
            const counts = { original: 0, strawberry: 0, cocoa: 0, matcha: 0 };
            (items || []).forEach(i => {
                const total = (i.balls || 0) * (i.qty || 0);
                const flavors = i.flavors || [];
                flavors.forEach(f => { if (counts[f] !== undefined) counts[f] += total / flavors.length; });
            });
            return Object.entries(counts).filter(([_, v]) => v > 0).map(([k, v]) => ({
                name: flavorNames[k],
                batches: Math.floor(v / 80),
                remainder: Math.round(v % 80),
                total: Math.round(v)
            }));
        };

        const App = () => {
            const [view, setView] = useState('main'); 
            const [activeTab, setActiveTab] = useState('order');
            const [listSubTab, setListSubTab] = useState('active'); 
            const [orders, setOrders] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [orderCategory, setOrderCategory] = useState('8å…¥');
            const [currentOrder, setCurrentOrder] = useState({
                name: '', phone: '', address: '', deliveryTime: '', 
                deliveryMethod: 'è‡ªå–', paymentMethod: 'åº—å…§çµå¸³', note: '', completed: false,
                items: [], extras: { cream: false, bag: true, receipt: false, sugar: false, fork: false }
            });
            const [selectedReceipt, setSelectedReceipt] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('gege_vHistory_Stable_Local_V21');
                if (saved) { try { setOrders(JSON.parse(saved)); } catch(e) {} }
            }, []);

            useEffect(() => {
                localStorage.setItem('gege_vHistory_Stable_Local_V21', JSON.stringify(orders));
            }, [orders]);

            const activeOrders = useMemo(() => orders.filter(o => !o.completed), [orders]);
            const historyOrders = useMemo(() => orders.filter(o => o.completed), [orders]);

            // è¨ˆç®—ä¸‹å–®é é¢é‡‘é¡
            const packingCurrent = useMemo(() => calculatePacking(currentOrder.items), [currentOrder.items]);
            const currentTotal = useMemo(() => {
                const iSum = currentOrder.items.reduce((s, i) => s + (i.price * (i.qty || 0)), 0);
                const bSum = currentOrder.extras.bag ? (packingCurrent.bag6 + packingCurrent.bag4) * 2 : 0;
                return iSum + bSum;
            }, [currentOrder.items, currentOrder.extras.bag, packingCurrent]);

            // --- ä¿®å¾©ç‡Ÿæ”¶çµ±è¨ˆåŠŸèƒ½ ---
            const monthlyStatistics = useMemo(() => {
                const monthsData = {};
                orders.forEach(order => {
                    // ä½¿ç”¨ç©©å®šçš„æ—¥æœŸè§£æ (è§£æè‡ª toLocaleString æˆ– ISO)
                    let date = order.isoDate ? new Date(order.isoDate) : new Date(order.timestamp.replace('ä¸‹åˆ', ' PM').replace('ä¸Šåˆ', ' AM'));
                    if (isNaN(date.getTime())) return;
                    
                    const monthKey = `${date.getFullYear()}/${date.getMonth() + 1}`;

                    if (!monthsData[monthKey]) {
                        monthsData[monthKey] = { original: 0, strawberry: 0, cocoa: 0, matcha: 0, totalAmount: 0 };
                    }
                    monthsData[monthKey].totalAmount += Number(order.totalAmount || 0);

                    order.items.forEach(item => {
                        const total = (item.balls || 0) * (item.qty || 0);
                        const perFlavor = total / (item.flavors?.length || 1);
                        item.flavors?.forEach(f => {
                            if (monthsData[monthKey][f] !== undefined) monthsData[monthKey][f] += perFlavor;
                        });
                    });
                });

                return Object.entries(monthsData).map(([month, data]) => ({
                    month,
                    totalAmount: data.totalAmount,
                    flavors: Object.entries(flavorNames).map(([k, name]) => ({
                        name,
                        balls: data[k],
                        batches: Math.floor(data[k] / 80),
                        remainder: Math.round(data[k] % 80)
                    })).filter(f => f.balls > 0)
                })).sort((a, b) => {
                    const [ay, am] = a.month.split('/');
                    const [by, bm] = b.month.split('/');
                    return new Date(by, bm - 1) - new Date(ay, am - 1);
                });
            }, [orders]);

            const doughTotalDemand = useMemo(() => {
                const totals = { original: 0, strawberry: 0, cocoa: 0, matcha: 0 };
                activeOrders.forEach(o => o.items.forEach(i => {
                    const total = (i.balls || 0) * (i.qty || 0);
                    i.flavors?.forEach(f => { if (totals[f] !== undefined) totals[f] += total / i.flavors.length; });
                }));
                return Object.entries(totals).filter(([_, v]) => v > 0).map(([k, v]) => ({
                    name: flavorNames[k], batches: Math.floor(v / 80), remainder: Math.round(v % 80), total: Math.round(v)
                }));
            }, [activeOrders]);

            const handleAddItem = (opt) => {
                const exist = currentOrder.items.find(i => i.id === opt.id);
                if (exist) {
                    setCurrentOrder({ ...currentOrder, items: currentOrder.items.map(i => i.id === opt.id ? { ...i, qty: (i.qty||0) + 1 } : i) });
                } else {
                    setCurrentOrder({ ...currentOrder, items: [...currentOrder.items, { ...opt, qty: 1 }] });
                }
            };

            const handleUpdateQty = (id, val) => {
                const num = val === '' ? '' : Math.max(0, parseInt(val) || 0);
                setCurrentOrder({
                    ...currentOrder,
                    items: currentOrder.items.map(i => i.id === id ? { ...i, qty: num } : i).filter(i => i.qty !== 0)
                });
            };

            const handleSave = () => {
                if (!currentOrder.name || currentOrder.items.length === 0) return;
                const now = new Date();
                if (editingId) {
                    setOrders(prev => prev.map(o => o.id === editingId ? { ...currentOrder, id: editingId, totalAmount: currentTotal, timestamp: o.timestamp, isoDate: o.isoDate || now.toISOString() } : o));
                    setEditingId(null);
                } else {
                    setOrders(prev => [{ ...currentOrder, id: Date.now(), totalAmount: currentTotal, timestamp: now.toLocaleString(), isoDate: now.toISOString() }, ...prev]);
                }
                setCurrentOrder({ name: '', phone: '', address: '', deliveryTime: '', deliveryMethod: 'è‡ªå–', paymentMethod: 'åº—å…§çµå¸³', note: '', items: [], extras: { cream: false, bag: true, receipt: false, sugar: false, fork: false }, completed: false });
                setActiveTab('list');
                setListSubTab('active');
            };

            const handleEditClick = (order) => {
                setCurrentOrder(order);
                setEditingId(order.id);
                setActiveTab('order');
                setView('main');
            };

            const toggleComplete = (id) => {
                setOrders(prev => prev.map(o => o.id === id ? { ...o, completed: !o.completed } : o));
            };

            const onCopyLine = (order) => {
                const p = calculatePacking(order.items);
                let payInfo = `ã€ä»˜æ¬¾æ–¹å¼ï¼š${order.paymentMethod}ã€‘`;
                if (order.paymentMethod === 'åŒ¯æ¬¾') {
                    payInfo += `\nğŸ¦ ä¸­ä¿¡(822) ${bankInfo.accountNumber}\nğŸ‘¤ å½­æ°¸ç¿” / æ ¸å°æœ«äº”ç¢¼`;
                } else if (order.paymentMethod === 'LinePay') {
                    payInfo += `\nâš ï¸ è«‹å‡ºç¤º LinePay æ¢ç¢¼æˆªåœ–ä¾›å°å¸³ã€‚`;
                }
                let itemsText = order.items.map(i => `â€¢ ${i.label} x ${i.qty} = $${i.price * i.qty}`).join('\n');
                let extras = Object.entries(order.extras).filter(([k,v]) => v && k !== 'bag').map(([k]) => extraNames[k]).join('ã€');
                let bagText = order.extras.bag ? `\nâ€¢ æè¢‹è²»($2) x ${p.bag6+p.bag4} = $${(p.bag6+p.bag4)*2}` : '';
                const text = `ã€è¯å¤«æ ¼æ ¼-å°å¸³æ˜ç´°ã€‘\nå®¢æˆ¶ï¼š${order.name}\nç¸½è¨ˆï¼š$ ${order.totalAmount}${payInfo}\n--------------------\n${itemsText}${extras ? '\nâ€¢ è¦æ±‚ï¼š' + extras : ''}${bagText}\n--------------------\nå‚™è¨»ï¼š${order.note || 'ç„¡'}`;
                const t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
                alert("å°å¸³æ–‡å­—å·²è¤‡è£½æˆåŠŸï¼");
                setView('main');
            };

            if (view === 'receipt' && selectedReceipt) {
                const p = calculatePacking(selectedReceipt.items);
                return (
                    <div className="min-h-screen bg-white animate-fade flex flex-col text-left font-black">
                        <div className="p-4 border-b flex items-center bg-white sticky top-0 z-50">
                            <button onClick={() => setView('main')} className="p-2 text-[#8E7D6F] flex items-center font-bold font-black"><Icon name="back" size={24}/> è¿”å›</button>
                            <h2 className="flex-1 text-center font-black text-[#5E503F]">æ”¶æ“šæ˜ç´°</h2>
                            <div className="flex items-center gap-1">
                                <button onClick={() => handleEditClick(selectedReceipt)} className="p-2 text-blue-500 active:scale-110"><Icon name="edit" size={24}/></button>
                                <button onClick={() => setView('main')} className="p-2 text-gray-300 font-black"><Icon name="close" size={24}/></button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 pb-40">
                            <div className="receipt-card">
                                <div className="text-center mb-6 border-b-2 border-dashed border-[#D5BDAF]/30 pb-4 font-black text-[#D5BDAF]">
                                    <h3 className="text-2xl font-black tracking-widest uppercase">è¯å¤«æ ¼æ ¼</h3>
                                    <p className="text-[10px] opacity-40 uppercase tracking-widest font-bold">Stable Management</p>
                                </div>
                                <div className="text-center mb-6 font-black text-[#5E503F]">
                                    <p className="text-4xl font-black tracking-tighter mb-3 font-black">{selectedReceipt.name}</p>
                                    <div className="flex justify-center gap-2 font-black">
                                        <span className="bg-[#8E7D6F] text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter"><Icon name="truck" size={10} className="inline mr-1"/>{selectedReceipt.deliveryMethod}</span>
                                        <span className="bg-[#D5BDAF] text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter"><Icon name="card" size={10} className="inline mr-1"/>{selectedReceipt.paymentMethod}</span>
                                    </div>
                                    {selectedReceipt.address && <p className="text-[11px] font-bold text-[#8E7D6F] flex items-center justify-center gap-1 mt-1 text-center font-black"><Icon name="pin" size={10}/>{selectedReceipt.address}</p>}
                                </div>
                                <div className="bg-white p-5 rounded-3xl border border-[#D5BDAF]/20 text-[12px] font-black mb-6 text-center">
                                    {selectedReceipt.paymentMethod === 'åŒ¯æ¬¾' ? (
                                        <div className="space-y-1 font-black">
                                            <p className="text-[#8E7D6F]">ğŸ¦ {bankInfo.bankName}</p>
                                            <p>ğŸ‘¤ {bankInfo.accountName}</p>
                                            <p className="text-lg tracking-wider font-black">{bankInfo.accountNumber}</p>
                                            <p className="text-[#D5BDAF] text-center mt-2 underline">åŒ¯æ¬¾å¾Œæä¾›å¸³è™Ÿæœ«äº”ç¢¼</p>
                                        </div>
                                    ) : selectedReceipt.paymentMethod === 'LinePay' ? (
                                        <div className="text-center py-2 text-red-500 font-black">
                                            <p className="text-lg underline decoration-wavy tracking-widest font-black">è«‹å‡ºç¤º LinePay æ¢ç¢¼çµå¸³</p>
                                        </div>
                                    ) : <p className="text-center opacity-40 py-2">ä»˜æ¬¾æ–¹å¼ï¼š{selectedReceipt.paymentMethod}</p>}
                                </div>
                                <div className="space-y-3 font-bold border-t border-gray-100 pt-4">
                                    {selectedReceipt.items.map((i, idx) => (
                                        <div key={idx} className="flex justify-between items-end border-b border-gray-50 pb-2">
                                            <div className="text-left leading-tight font-black"><p className="text-lg font-black">â€¢ {i.label}</p><p className="text-[10px] opacity-40">$ {i.price} x {i.qty}</p></div>
                                            <span className="text-[#8E7D6F] font-black">$ {i.price * i.qty}</span>
                                        </div>
                                    ))}
                                    <div className="space-y-1 text-sm pt-2 font-black">
                                        {Object.entries(selectedReceipt.extras).map(([k,v]) => (v && k !== 'bag') ? <div key={k} className="flex justify-between text-gray-500 font-black"><span>â€¢ {extraNames[k]}</span><span>$ 0</span></div> : null)}
                                        {selectedReceipt.extras.bag && (p.bag6 > 0 || p.bag4 > 0) && (
                                            <React.Fragment>
                                                {p.bag6 > 0 && <div className="flex justify-between font-black"><span>â€¢ å°ˆç”¨ 6æ¯æè¢‹ ($2) x {p.bag6}</span><span>$ {p.bag6 * 2}</span></div>}
                                                {p.bag4 > 0 && <div className="flex justify-between font-black"><span>â€¢ å°ˆç”¨ 4æ¯æè¢‹ ($2) x {p.bag4}</span><span>$ {p.bag4 * 2}</span></div>}
                                            </React.Fragment>
                                        )}
                                        {p.cooler > 0 && <div className="flex justify-between text-blue-600 font-black pt-1 bg-blue-50/50 p-2 rounded-xl mt-2 italic font-black"><span>â€¢ è´ˆé€ï¼šçœŸç©ºåŒ…å°ˆç”¨ä¿å†·è¢‹</span><span>x {p.cooler} å€‹</span></div>}
                                    </div>
                                </div>
                                <div className="bg-[#8E7D6F] p-6 rounded-[2rem] flex justify-between items-center text-white my-6 font-black">
                                    <p className="text-xs font-black uppercase tracking-widest">æ‡‰ä»˜ç¸½è¨ˆ TOTAL</p>
                                    <p className="text-3xl font-black">$ {selectedReceipt.totalAmount}</p>
                                </div>
                                {selectedReceipt.note && <div className="bg-white p-4 rounded-2xl border-2 border-dashed border-[#D5BDAF]/30 text-xs italic font-bold text-center text-gray-500 font-black">"{selectedReceipt.note}"</div>}
                            </div>
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-50">
                            <button onClick={() => onCopyLine(selectedReceipt)} className="w-full bg-[#8E7D6F] text-white p-5 rounded-2xl font-black text-xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-all font-black">
                                <Icon name="send" /> ä¸€éµè¤‡è£½æ˜ç´°ä¸¦å›æ¸…å–®
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 text-left font-black">
                    <nav className="fixed bottom-0 left-0 right-0 z-40 bg-[#D5BDAF] p-3 flex justify-around shadow-lg rounded-t-[2rem]">
                        {[
                            { id: 'order', label: editingId ? 'ä¿®æ”¹' : 'ä¸‹å–®', icon: <Icon name="plus" size={20}/> },
                            { id: 'calc', label: 'å‚™è²¨', icon: <Icon name="chef" size={20}/> },
                            { id: 'stats', label: 'æ•¸æ“š', icon: <Icon name="chart" size={20}/> },
                            { id: 'list', label: 'æ¸…å–®', icon: <Icon name="clipboard" size={20}/> },
                        ].map(t => (
                            <button key={t.id} onClick={() => {setActiveTab(t.id); setEditingId(null);}} className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${activeTab === t.id ? 'bg-[#FDF8F5] text-[#8E7D6F] scale-110 shadow-inner' : 'text-white opacity-70'}`}>
                                {t.icon}<span className="text-[10px] font-bold font-black">{t.label}</span>
                            </button>
                        ))}
                    </nav>

                    <main className="p-4 max-w-lg mx-auto space-y-6 pt-4 animate-fade font-black">
                        {activeTab === 'order' && (
                            <div className="space-y-4">
                                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-[#E3D5CA] space-y-4 text-left">
                                    <h2 className="text-lg font-black text-[#8E7D6F] flex items-center gap-2 font-black text-left font-black font-black"><Icon name="user" size={18} /> {editingId ? 'ä¿®æ”¹è¨‚å–®è³‡æ–™' : 'å®¢æˆ¶åŸºæœ¬è³‡æ–™'}</h2>
                                    <input type="text" placeholder="å®¢æˆ¶å§“å" className="w-full bg-[#F9F6F4] rounded-xl p-3 outline-none font-black text-base border-transparent border font-black" value={currentOrder.name} onChange={e => setCurrentOrder({...currentOrder, name: e.target.value})} />
                                    <input type="tel" placeholder="é›»è©±" className="w-full bg-[#F9F6F4] rounded-xl p-3 outline-none font-black text-base border-transparent border font-black" value={currentOrder.phone} onChange={e => setCurrentOrder({...currentOrder, phone: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-2 text-[10px] font-black">
                                        <div className="flex bg-[#F9F6F4] rounded-xl p-1">
                                            {['è‡ªå–', 'å¤–é€', 'Panda'].map(m => (
                                                <button key={m} onClick={() => setCurrentOrder({...currentOrder, deliveryMethod: m})} className={`flex-1 py-1.5 rounded-lg font-black ${currentOrder.deliveryMethod === m ? 'bg-[#8E7D6F] text-white shadow-sm' : 'text-[#8E7D6F]'}`}>{m}</button>
                                            ))}
                                        </div>
                                        <div className="flex bg-[#F9F6F4] rounded-xl p-1 font-black">
                                            {['åº—å…§', 'LinePay', 'åŒ¯æ¬¾'].map(m => (
                                                <button key={m} onClick={() => setCurrentOrder({...currentOrder, paymentMethod: m})} className={`flex-1 py-1.5 rounded-lg font-black ${currentOrder.paymentMethod === m ? 'bg-[#8E7D6F] text-white shadow-sm' : 'text-[#8E7D6F]'}`}>{m}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <input type="text" placeholder="åœ°å€ (å¤–é€å¿…å¡«)" className="w-full bg-[#F9F6F4] rounded-xl p-3 outline-none text-sm font-black font-black" value={currentOrder.address} onChange={e => setCurrentOrder({...currentOrder, address: e.target.value})} />
                                    <input type="datetime-local" className="w-full bg-[#F9F6F4] rounded-xl p-3 outline-none font-bold text-[#8E7D6F] font-black font-black" value={currentOrder.deliveryTime} onChange={e => setCurrentOrder({...currentOrder, deliveryTime: e.target.value})} />
                                </div>

                                <div className="bg-white rounded-[2.5rem] p-6 shadow-sm border border-[#E3D5CA] space-y-4 font-black">
                                    <h2 className="text-lg font-black text-[#8E7D6F] flex items-center gap-2 font-black font-black font-black"><Icon name="cart" size={18} /> ç”¢å“è¦æ ¼é¸æ“‡</h2>
                                    <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar font-black">
                                        {Object.keys(productCategories).map(cat => (
                                            <button key={cat} onClick={() => setOrderCategory(cat)} className={`flex-shrink-0 px-4 py-1.5 rounded-full text-[10px] font-black ${orderCategory === cat ? 'bg-[#8E7D6F] text-white shadow-md' : 'bg-[#E3D5CA]'}`}>{cat}</button>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 text-left font-bold font-black">
                                        {productCategories[orderCategory].map(opt => (
                                            <button key={opt.id} onClick={() => handleAddItem(opt)} className="p-3 bg-[#F9F6F4] rounded-2xl border border-transparent active:border-[#D5BDAF] transition-all text-left font-black">
                                                <p className="text-xs font-black">{opt.label}</p>
                                                <p className="text-[10px] text-[#8E7D6F] font-black">$ {opt.price}</p>
                                            </button>
                                        ))}
                                    </div>
                                    {currentOrder.items.length > 0 && (
                                        <div className="pt-4 border-t border-dashed space-y-2 font-black text-left">
                                            {currentOrder.items.map(i => (
                                                <div key={i.id} className="flex justify-between items-center bg-[#FDF8F5] p-3 rounded-xl border border-[#E3D5CA]/50 text-xs">
                                                    <span className="flex-1 font-black">{i.label}</span>
                                                    <div className="flex items-center gap-2 font-black">
                                                        <button onClick={() => handleUpdateQty(i.id, (i.qty||0) - 1)} className="p-1 active:scale-75 text-[#D5BDAF] font-black"><Icon name="minus" size={14}/></button>
                                                        <span className="font-black w-6 text-center">{i.qty}</span>
                                                        <button onClick={() => handleUpdateQty(i.id, (i.qty||0) + 1)} className="p-1 active:scale-75 text-[#D5BDAF] font-black"><Icon name="plus" size={14}/></button>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="bg-[#8E7D6F] text-white p-3 rounded-xl flex justify-between font-black shadow-md mt-2"><span>ç•¶å‰å°è¨ˆ</span><span>$ {currentTotal}</span></div>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-white rounded-[2.5rem] p-6 shadow-sm border border-[#E3D5CA] space-y-4 font-black text-left font-black">
                                    <h2 className="text-lg font-black text-[#8E7D6F] flex items-center gap-2 font-black font-black font-black"><Icon name="gift" size={18} /> åŠ è³¼é …ç›®èˆ‡å‚™è¨»</h2>
                                    <div className="grid grid-cols-2 gap-2 text-[10px] font-black">
                                        {Object.entries(extraNames).map(([k, label]) => (
                                            <button key={k} onClick={() => setCurrentOrder({...currentOrder, extras: {...currentOrder.extras, [k]: !currentOrder.extras[k]}})} className={`p-3 rounded-xl border flex items-center justify-between transition-all font-black ${currentOrder.extras[k] ? 'bg-[#D5BDAF] text-white border-transparent shadow-sm' : 'bg-[#F9F6F4]'}`}><span>{label}</span>{currentOrder.extras[k] && <Icon name="check" size={14} />}</button>
                                        ))}
                                    </div>
                                    <textarea placeholder="é»æ­¤è¼¸å…¥ç‰¹åˆ¥è¦æ±‚..." className="w-full bg-[#F9F6F4] rounded-xl p-4 outline-none text-sm font-black min-h-[80px] font-black font-black" value={currentOrder.note} onChange={e => setCurrentOrder({...currentOrder, note: e.target.value})}></textarea>
                                </div>
                                <button onClick={handleSave} className="w-full bg-[#8E7D6F] text-white p-5 rounded-[2rem] font-black text-xl shadow-xl active:scale-95 transition-all font-black font-black">ç¢ºèªå„²å­˜è¨‚å–®</button>
                            </div>
                        )}

                        {activeTab === 'calc' && (
                            <div className="bg-white rounded-[2rem] p-8 shadow-sm border border-[#E3D5CA] space-y-6 font-black text-left animate-fade font-black">
                                <h2 className="text-xl font-black text-[#8E7D6F] flex items-center justify-center gap-3 font-black"><Icon name="chef" size={24} /> ç•¶å‰æ‰éºµç¸½é‡éœ€æ±‚ (æœªå®Œæˆå–®)</h2>
                                <div className="space-y-4 font-black text-left font-black font-black">
                                    {doughTotalDemand.map(d => (
                                        <div key={d.name} className="p-6 bg-[#FDF8F5] rounded-3xl border border-[#D5BDAF]/20 flex justify-between items-center shadow-inner font-black">
                                            <p className="text-xl text-[#5E503F] font-black">{d.name}</p>
                                            <div className="text-right font-black">
                                                <p className="text-2xl text-[#8E7D6F] font-black font-black font-black">{d.batches > 0 ? `${d.batches} åœ˜ åˆ ${d.remainder} é¡†` : `1 åœ˜ (åƒ…éœ€ ${d.total} é¡†)`}</p>
                                                <p className="text-[10px] opacity-40 uppercase text-[#D5BDAF] font-black">æ‰éºµä»½é‡ (1åœ˜=80é¡†)</p>
                                            </div>
                                        </div>
                                    ))}
                                    {doughTotalDemand.length === 0 && <div className="py-24 text-center opacity-30 italic font-black text-lg font-black font-black font-black">ç›®å‰å°šç„¡å‚™è²¨éœ€æ±‚</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6 text-left font-black animate-fade font-black text-left font-black">
                                {monthlyStatistics.map(stat => (
                                    <div key={stat.month} className="bg-white rounded-[2.5rem] p-6 shadow-sm border border-[#E3D5CA] space-y-4 font-black">
                                        <div className="flex justify-between items-end border-b-2 border-dashed border-[#D5BDAF]/30 pb-3 font-black text-left font-black font-black">
                                            <h2 className="text-2xl font-black text-[#8E7D6F] font-black font-black font-black">{stat.month} æ•¸æ“šçµ±è¨ˆ</h2>
                                            <p className="text-xl font-black text-[#5E503F] underline decoration-double font-black font-black font-black font-black">æœˆç‡Ÿæ”¶: $ {stat.totalAmount}</p>
                                        </div>
                                        <div className="space-y-2 font-black text-left font-black font-black">
                                            <p className="text-[10px] text-[#D5BDAF] uppercase tracking-widest font-black font-black font-black font-black">â€” å„å£å‘³æ¶ˆè€—åœ˜æ•¸ â€”</p>
                                            {stat.flavors.map((f, i) => (
                                                <div key={f.name} className="flex justify-between p-4 bg-[#F9F6F4] rounded-2xl font-black font-black font-black font-black">
                                                    <div className="flex items-center gap-3">
                                                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] text-white ${i===0?'bg-yellow-400 font-black':'bg-[#D5BDAF]'}`}>{i+1}</span>
                                                        <span className="font-black font-black font-black">{f.name}</span>
                                                    </div>
                                                    <span className="text-[#8E7D6F] font-black font-black font-black">
                                                        {f.batches > 0 ? `${f.batches} åœ˜ åˆ ${f.remainder} é¡†` : `${f.remainder} é¡†`}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                {monthlyStatistics.length === 0 && <div className="py-40 text-center opacity-30 italic font-black text-lg font-black font-black font-black font-black font-black font-black">ç›®å‰å°šæœªæœ‰ä»»ä½•ç‡Ÿæ”¶ç´€éŒ„</div>}
                            </div>
                        )}

                        {activeTab === 'list' && (
                            <div className="space-y-4 text-left font-black animate-fade text-left font-black font-black font-black font-black">
                                <div className="flex bg-[#E3D5CA] p-1.5 rounded-2xl mb-4 font-black">
                                    <button onClick={() => setListSubTab('active')} className={`flex-1 py-2 rounded-xl text-sm transition-all font-black font-black ${listSubTab === 'active' ? 'bg-white text-[#8E7D6F] shadow-sm' : 'text-white'}`}>å¾…å‡ºè²¨ ({activeOrders.length})</button>
                                    <button onClick={() => setListSubTab('history')} className={`flex-1 py-2 rounded-xl text-sm transition-all font-black font-black ${listSubTab === 'history' ? 'bg-white text-[#8E7D6F] shadow-sm' : 'text-white'}`}>æ­·å²è¨‚å–® ({historyOrders.length})</button>
                                </div>

                                {listSubTab === 'active' ? (
                                    activeOrders.map(o => (
                                        <div key={o.id} className="bg-white rounded-[2.5rem] p-5 border border-[#E3D5CA] shadow-sm relative overflow-hidden font-black mb-4 font-black font-black font-black font-black">
                                            <div className="absolute top-0 left-0 w-1.5 h-full bg-[#D5BDAF] opacity-30 font-black font-black font-black font-black"></div>
                                            <div className="flex justify-between items-start mb-3 font-black font-black font-black font-black">
                                                <div onClick={() => {setSelectedReceipt(o); setView('receipt');}} className="flex-1 cursor-pointer font-black text-left font-black font-black font-black font-black">
                                                    <h3 className="text-xl font-black text-[#5E503F] underline decoration-[#D5BDAF]/30 decoration-dashed font-black font-black font-black font-black font-black">{o.name || 'å®¢æˆ¶'}</h3>
                                                    <p className="text-lg font-black text-[#8E7D6F] mt-1 font-black font-black font-black font-black">$ {o.totalAmount}</p>
                                                    <p className="text-[10px] font-bold opacity-30 mt-1 uppercase tracking-widest font-black font-black font-black font-black font-black">{o.deliveryMethod} â€¢ {o.paymentMethod}</p>
                                                </div>
                                                <div className="flex flex-col gap-2 font-black text-right font-black font-black font-black font-black font-black font-black">
                                                    <button onClick={() => toggleComplete(o.id)} title="æ¨™è¨˜å®Œæˆ" className="bg-green-50 text-green-500 p-2 rounded-full border border-green-100 active:scale-125 font-black font-black font-black font-black font-black font-black"><Icon name="check" size={18}/></button>
                                                    <button onClick={() => handleEditClick(o)} className="text-[#D5BDAF] p-2 active:scale-125 font-black font-black font-black font-black font-black font-black font-black font-black"><Icon name="edit" size={18}/></button>
                                                    <button onClick={() => {if(window.confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setOrders(prev => prev.filter(ord => ord.id !== o.id))}} className="text-red-200 p-2 font-black font-black font-black font-black font-black font-black font-black font-black"><Icon name="trash" size={18}/></button>
                                                </div>
                                            </div>
                                            <div className="bg-[#FDF8F5] p-3 rounded-2xl border border-[#D5BDAF]/20 shadow-inner font-black text-left font-black font-black font-black font-black font-black font-black font-black font-black">
                                                <p className="text-[9px] font-black text-[#8E7D6F] uppercase mb-1 flex items-center gap-1 font-black tracking-widest font-black font-black font-black font-black font-black font-black font-black font-black font-black"><Icon name="target" size={10}/> å‚™è²¨åƒè€ƒ</p>
                                                {getDoughDemand(o.items).map(d => (
                                                    <div key={d.name} className="flex justify-between text-[11px] py-0.5 border-b border-white last:border-0 font-black text-left font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                                                        <span>{d.name}</span>
                                                        <span className="text-[#8E7D6F] font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">{d.batches > 0 ? `${d.batches} åœ˜ åˆ ${d.remainder} é¡†` : `1 åœ˜ (åƒ…éœ€ ${d.remainder} é¡†)`}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    historyOrders.map(o => (
                                        <div key={o.id} className="bg-[#F9F6F4] opacity-70 grayscale rounded-[2.5rem] p-5 border border-dashed border-[#D5BDAF] shadow-sm relative overflow-hidden font-black mb-4 font-black text-left font-black font-black font-black font-black font-black font-black font-black font-black">
                                            <div className="flex justify-between items-start font-black text-left font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                                                <div onClick={() => {setSelectedReceipt(o); setView('receipt');}} className="flex-1 cursor-pointer font-black text-left text-left font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                                                    <h3 className="text-xl font-black text-gray-500 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">{o.name} (å·²å®Œçµ)</h3>
                                                    <p className="text-lg font-black text-gray-400 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">$ {o.totalAmount}</p>
                                                    <p className="text-[10px] opacity-40 font-black tracking-tight font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">{o.timestamp}</p>
                                                </div>
                                                <div className="flex flex-col gap-2 font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                                                    <button onClick={() => toggleComplete(o.id)} title="é‚„åŸå–®æ“š" className="bg-blue-50 text-blue-500 p-2 rounded-full border border-blue-100 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black"><Icon name="undo" size={18}/></button>
                                                    <button onClick={() => {if(window.confirm('ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')) setOrders(prev => prev.filter(ord => ord.id !== o.id))}} className="text-red-300 p-2 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black"><Icon name="trash" size={18}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                                {activeOrders.length === 0 && listSubTab === 'active' && <div className="py-24 text-center opacity-30 italic font-black text-lg font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">ç›®å‰ç„¡å¾…å‡ºè²¨å–®æ“š</div>}
                                {historyOrders.length === 0 && listSubTab === 'history' && <div className="py-24 text-center opacity-30 italic font-black text-lg font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">å°šç„¡æ­·å²è¨‚å–®ç´€éŒ„</div>}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
